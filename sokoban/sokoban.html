<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨ç®±å­ - åœäº‘çŒ®ç¤¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #ff6b6b;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
            margin-bottom: 10px;
        }

        .header p {
            color: #a0a0a0;
            font-style: italic;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .info-bar span {
            color: #fff;
            font-size: 1.1em;
        }

        .level-display {
            color: #ffd93d !important;
            font-weight: bold;
        }

        .game-board {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        #gameCanvas {
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.3);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffd93d, #f0c419);
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .direction-controls {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .dir-btn {
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dir-btn:hover {
            transform: scale(1.1);
        }

        .dir-btn:active {
            transform: scale(0.95);
        }

        .dir-btn.empty {
            visibility: hidden;
        }

        .level-select {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            max-width: 400px;
            margin: 0 auto 20px;
        }

        .level-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #ff6b6b;
            border-radius: 8px;
            background: rgba(255, 107, 107, 0.2);
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .level-btn:hover {
            background: rgba(255, 107, 107, 0.5);
        }

        .level-btn.completed {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border-color: #4ecdc4;
        }

        .level-btn.current {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            transform: scale(1.1);
        }

        .message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }

        .message.success {
            display: block;
            background: rgba(78, 205, 196, 0.3);
            color: #4ecdc4;
            border: 1px solid #4ecdc4;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ccc;
            font-size: 0.9em;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.8em;
            }

            .info-bar {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>ğŸ¦Š æ¨ç®±å­ ğŸ®</h1>
            <p>ã€Œæ©å…¬ï¼Œæ­¤ä¹ƒå°å¥³å­åœäº‘ä¸ºæ‚¨ç²¾å¿ƒå‡†å¤‡çš„ç›Šæ™ºå°æˆã€</p>
        </div>

        <div class="info-bar">
            <span class="level-display">ç¬¬ <span id="currentLevel">1</span> å…³</span>
            <span>æ­¥æ•°: <span id="moves">0</span></span>
            <span>æ¨ç®±: <span id="pushes">0</span></span>
        </div>

        <div id="messageBox" class="message"></div>

        <div class="game-board">
            <canvas id="gameCanvas" width="400" height="400"></canvas>
        </div>

        <div class="direction-controls">
            <button class="dir-btn empty"></button>
            <button class="dir-btn" onclick="move('up')">â¬†ï¸</button>
            <button class="dir-btn empty"></button>
            <button class="dir-btn" onclick="move('left')">â¬…ï¸</button>
            <button class="dir-btn" onclick="move('down')">â¬‡ï¸</button>
            <button class="dir-btn" onclick="move('right')">â¡ï¸</button>
        </div>

        <div class="controls">
            <button class="btn btn-warning" onclick="restartLevel()">ğŸ”„ é‡ç©æœ¬å…³</button>
            <button class="btn btn-secondary" onclick="undoMove()">â†©ï¸ æ’¤é”€</button>
            <button class="btn btn-primary" onclick="prevLevel()">â¬…ï¸ ä¸Šä¸€å…³</button>
            <button class="btn btn-primary" onclick="nextLevel()">â¡ï¸ ä¸‹ä¸€å…³</button>
            <button class="btn btn-warning" onclick="Leaderboard.show('sokoban')">ğŸ† æ’è¡Œæ¦œ</button>
        </div>

        <div class="level-select" id="levelSelect"></div>


        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #8B4513;"></div>
                <span>å¢™å£</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFD700;"></div>
                <span>ç®±å­</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF6B6B;"></div>
                <span>ç›®æ ‡</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4ECDC4;"></div>
                <span>ç©å®¶</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #32CD32;"></div>
                <span>å®Œæˆ</span>
            </div>
        </div>
    </div>

    <script src="levels.js"></script>
    <script src="../leaderboard.js"></script>
    <script>
        // åœ°å›¾å…ƒç´ å®šä¹‰
        const EMPTY = 0;
        const WALL = 1;
        const BOX = 2;
        const TARGET = 3;
        const PLAYER = 4;
        const BOX_ON_TARGET = 5;
        const PLAYER_ON_TARGET = 6;

        // æ¸¸æˆçŠ¶æ€
        let currentLevel = 0;

        let gameMap = [];
        let playerPos = { x: 0, y: 0 };
        let moves = 0;
        let pushes = 0;
        let history = [];
        let completedLevels = new Set();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // æ·±æ‹·è´åœ°å›¾
        function cloneMap(map) {
            return map.map(row => [...row]);
        }

        // åˆå§‹åŒ–å…³å¡
        function initLevel(levelIndex) {
            currentLevel = levelIndex;
            const level = levels[levelIndex];
            gameMap = cloneMap(level.map);
            moves = 0;
            pushes = 0;
            history = [];
            
            // æ‰¾åˆ°ç©å®¶ä½ç½®
            for (let y = 0; y < gameMap.length; y++) {
                for (let x = 0; x < gameMap[y].length; x++) {
                    if (gameMap[y][x] === PLAYER || gameMap[y][x] === PLAYER_ON_TARGET) {
                        playerPos = { x, y };
                    }
                }
            }

            updateDisplay();
            render();
            hideMessage();
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            document.getElementById('currentLevel').textContent = currentLevel + 1;
            document.getElementById('moves').textContent = moves;
            document.getElementById('pushes').textContent = pushes;
            updateLevelButtons();
        }

        // æ¸²æŸ“æ¸¸æˆç”»é¢
        function render() {
            const rows = gameMap.length;
            const cols = gameMap[0].length;
            const cellSize = Math.min(400 / cols, 400 / rows);
            
            canvas.width = cols * cellSize;
            canvas.height = rows * cellSize;

            ctx.fillStyle = '#2d2d44';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const cell = gameMap[y][x];
                    const px = x * cellSize;
                    const py = y * cellSize;

                    // ç»˜åˆ¶åœ°æ¿
                    ctx.fillStyle = '#3d3d5c';
                    ctx.fillRect(px + 1, py + 1, cellSize - 2, cellSize - 2);

                    switch (cell) {
                        case WALL:
                            drawWall(px, py, cellSize);
                            break;
                        case BOX:
                            drawBox(px, py, cellSize, false);
                            break;
                        case TARGET:
                            drawTarget(px, py, cellSize);
                            break;
                        case PLAYER:
                            drawPlayer(px, py, cellSize);
                            break;
                        case BOX_ON_TARGET:
                            drawTarget(px, py, cellSize);
                            drawBox(px, py, cellSize, true);
                            break;
                        case PLAYER_ON_TARGET:
                            drawTarget(px, py, cellSize);
                            drawPlayer(px, py, cellSize);
                            break;
                    }
                }
            }
        }

        function drawWall(x, y, size) {
            const gradient = ctx.createLinearGradient(x, y, x + size, y + size);
            gradient.addColorStop(0, '#8B4513');
            gradient.addColorStop(1, '#654321');
            ctx.fillStyle = gradient;
            ctx.fillRect(x + 2, y + 2, size - 4, size - 4);
            
            ctx.strokeStyle = '#5D3A1A';
            ctx.lineWidth = 2;
            ctx.strokeRect(x + 2, y + 2, size - 4, size - 4);
        }

        function drawBox(x, y, size, onTarget) {
            const gradient = ctx.createRadialGradient(
                x + size/2, y + size/2, 0,
                x + size/2, y + size/2, size/2
            );
            if (onTarget) {
                gradient.addColorStop(0, '#32CD32');
                gradient.addColorStop(1, '#228B22');
            } else {
                gradient.addColorStop(0, '#FFD700');
                gradient.addColorStop(1, '#DAA520');
            }
            ctx.fillStyle = gradient;
            
            const padding = size * 0.15;
            ctx.beginPath();
            ctx.roundRect(x + padding, y + padding, size - padding*2, size - padding*2, 5);
            ctx.fill();
            
            ctx.strokeStyle = onTarget ? '#006400' : '#B8860B';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function drawTarget(x, y, size) {
            ctx.fillStyle = 'rgba(255, 107, 107, 0.5)';
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/3, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = '#FF6B6B';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function drawPlayer(x, y, size) {
            // èº«ä½“
            const gradient = ctx.createRadialGradient(
                x + size/2, y + size/2, 0,
                x + size/2, y + size/2, size/2
            );
            gradient.addColorStop(0, '#4ECDC4');
            gradient.addColorStop(1, '#26A69A');
            ctx.fillStyle = gradient;
            
            ctx.beginPath();
            ctx.arc(x + size/2, y + size/2, size/3, 0, Math.PI * 2);
            ctx.fill();
            
            // çœ¼ç›
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(x + size/2 - size/10, y + size/2 - size/10, size/12, 0, Math.PI * 2);
            ctx.arc(x + size/2 + size/10, y + size/2 - size/10, size/12, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(x + size/2 - size/10, y + size/2 - size/10, size/20, 0, Math.PI * 2);
            ctx.arc(x + size/2 + size/10, y + size/2 - size/10, size/20, 0, Math.PI * 2);
            ctx.fill();
        }

        // ç§»åŠ¨é€»è¾‘
        function move(direction) {
            const dx = { up: 0, down: 0, left: -1, right: 1 }[direction];
            const dy = { up: -1, down: 1, left: 0, right: 0 }[direction];
            
            const newX = playerPos.x + dx;
            const newY = playerPos.y + dy;
            const beyondX = newX + dx;
            const beyondY = newY + dy;

            const targetCell = gameMap[newY]?.[newX];
            
            if (targetCell === undefined || targetCell === WALL) {
                return; // æ’å¢™
            }

            // ä¿å­˜å†å²
            history.push({
                map: cloneMap(gameMap),
                playerPos: { ...playerPos },
                moves: moves,
                pushes: pushes
            });

            // æ£€æŸ¥æ˜¯å¦æ¨ç®±å­
            if (targetCell === BOX || targetCell === BOX_ON_TARGET) {
                const beyondCell = gameMap[beyondY]?.[beyondX];
                
                if (beyondCell === undefined || beyondCell === WALL || 
                    beyondCell === BOX || beyondCell === BOX_ON_TARGET) {
                    history.pop();
                    return; // æ— æ³•æ¨åŠ¨
                }

                // ç§»åŠ¨ç®±å­
                gameMap[beyondY][beyondX] = beyondCell === TARGET ? BOX_ON_TARGET : BOX;
                gameMap[newY][newX] = targetCell === BOX_ON_TARGET ? TARGET : EMPTY;
                pushes++;
            }

            // ç§»åŠ¨ç©å®¶
            const currentCell = gameMap[playerPos.y][playerPos.x];
            gameMap[playerPos.y][playerPos.x] = currentCell === PLAYER_ON_TARGET ? TARGET : EMPTY;
            
            const newCell = gameMap[newY][newX];
            gameMap[newY][newX] = newCell === TARGET ? PLAYER_ON_TARGET : PLAYER;
            
            playerPos = { x: newX, y: newY };
            moves++;

            updateDisplay();
            render();
            checkWin();
        }

        // æ£€æŸ¥èƒœåˆ©
        function checkWin() {
            for (let y = 0; y < gameMap.length; y++) {
                for (let x = 0; x < gameMap[y].length; x++) {
                    if (gameMap[y][x] === TARGET || gameMap[y][x] === PLAYER_ON_TARGET) {
                        return false;
                    }
                }
            }
            
            completedLevels.add(currentLevel);
            
            // æäº¤æˆç»©ï¼šé€šå…³æ•°é‡
            const totalCleared = completedLevels.size;
            Leaderboard.submit('sokoban', totalCleared, `å·²é€šå…³ ${totalCleared} å…³`);

            showMessage(`ğŸ‰ æ­å–œé€šå…³ï¼æ­¥æ•°: ${moves}, æ¨ç®±: ${pushes}`);

            updateLevelButtons();
            
            setTimeout(() => {
                if (currentLevel < levels.length - 1) {
                    if (confirm('æ©å…¬ç¥æ­¦ï¼æ˜¯å¦æŒ‘æˆ˜ä¸‹ä¸€å…³ï¼Ÿ')) {
                        nextLevel();
                    }
                } else {
                    alert('ğŸ† æ©å…¬çœŸä¹ƒå¤©çºµå¥‡æ‰ï¼');
                }
            }, 500);
            
            return true;
        }

        // æ’¤é”€ç§»åŠ¨
        function undoMove() {
            if (history.length === 0) return;
            
            const state = history.pop();
            gameMap = state.map;
            playerPos = state.playerPos;
            moves = state.moves;
            pushes = state.pushes;
            
            updateDisplay();
            render();
            hideMessage();
        }

        // é‡ç©æœ¬å…³
        function restartLevel() {
            initLevel(currentLevel);
        }

        // ä¸Šä¸€å…³
        function prevLevel() {
            if (currentLevel > 0) {
                initLevel(currentLevel - 1);
            }
        }

        // ä¸‹ä¸€å…³
        function nextLevel() {
            if (currentLevel < levels.length - 1) {
                initLevel(currentLevel + 1);
            }
        }

        // é€‰æ‹©å…³å¡
        function selectLevel(index) {
            initLevel(index);
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text) {
            const box = document.getElementById('messageBox');
            box.textContent = text;
            box.className = 'message success';
        }

        // éšè—æ¶ˆæ¯
        function hideMessage() {
            document.getElementById('messageBox').className = 'message';
        }

        // æ›´æ–°å…³å¡æŒ‰é’®
        function updateLevelButtons() {
            const container = document.getElementById('levelSelect');
            container.innerHTML = '';
            
            for (let i = 0; i < levels.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                btn.textContent = i + 1;
                btn.onclick = () => selectLevel(i);
                
                if (completedLevels.has(i)) {
                    btn.classList.add('completed');
                }
                if (i === currentLevel) {
                    btn.classList.add('current');
                }
                
                container.appendChild(btn);
            }
        }

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    e.preventDefault();
                    move('up');
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    e.preventDefault();
                    move('down');
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    e.preventDefault();
                    move('left');
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    e.preventDefault();
                    move('right');
                    break;
                case 'z':
                case 'Z':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        undoMove();
                    }
                    break;
                case 'r':
                case 'R':
                    restartLevel();
                    break;
            }
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        initLevel(0);
    </script>
</body>
</html>